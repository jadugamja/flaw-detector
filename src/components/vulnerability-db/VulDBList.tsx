import {
  Card,
  CardContent,
  CardFooter,
  CardHeader,
  CardSubTitle,
  CardTitle,
} from "@/components/ui/Card";
import { IconExternalLink } from "@/components/ui/Icons";
import { Label } from "@/components/ui/Label";
import { increasePostViews } from "@/lib/api/posts";
import { addPinnedPostToUser } from "@/lib/api/users";
import { formatTimestampAsDaysAgo } from "@/lib/utils";
import { VulDBPinnedInfo, VulDBPostWithChip } from "@/types/post";
import { isCertCCContentType, isCnnvdContentType } from "@/types/typeGuards";
import Link from "next/link";
import { LabelSkeleton } from "./ArticleDetailHeader";
import VulDBPin from "./VulDBPin";

export function VulDBListCardSkeleton() {
  return (
    <Card
      variant="article"
      size="long"
      className="h-[16.875rem] animate-pulse rounded-[1.25rem] border-line-light"
    >
      <CardHeader className="gap-0">
        <div className="mb-3 flex items-center gap-2">
          <LabelSkeleton />
          {/* Label */}
          <div className="h-7 w-4/5 rounded bg-gray-200"></div> {/* Title */}
        </div>
        <div className="h-5 w-1/12 rounded bg-gray-200"></div> {/* Subtitle */}
      </CardHeader>
      <CardContent className="bg-gray-200" />
      <CardFooter>
        <div className="flex gap-3">
          <div className="h-7 w-7 rounded-full bg-gray-200"></div>
          {/* IconPin */}
          <div className="h-7 w-7 rounded-full bg-gray-200"></div>
          {/* IconExternalLink */}
        </div>
        <div className="h-6 w-16 rounded bg-gray-200"></div> {/* Date */}
      </CardFooter>
    </Card>
  );
}

function VulDBListCard({
  post,
  userId,
}: {
  post: VulDBPostWithChip;
  userId: string;
}) {
  if (!post) return null;

  const pinnedInfo: VulDBPinnedInfo = { userId, postId: post.id };

  const daysAgo = formatTimestampAsDaysAgo(post.created_at);
  return (
    <Card
      variant="article"
      size="long"
      className="h-[16.875rem] rounded-[1.25rem] border-line-light"
    >
      <CardHeader>
        <div className="mb-3 flex items-center gap-2">
          {post.chip === "new" && <Label variant="new">NEW</Label>}
          {post.chip === "hot" && <Label>HOT</Label>}
          <CardTitle
            size="small"
            weight="bold"
            color="black"
            className="line-clamp-1"
          >
            {post.title?.translated ||
              post.title?.original ||
              "제목을 불러오는 데 실패했습니다."}
          </CardTitle>
        </div>
        <CardSubTitle
          isSingleLine
          className="block truncate font-medium text-line-dark"
        >
          {post.source || "출처를 알 수 없음"}
        </CardSubTitle>
      </CardHeader>
      <CardContent className="bg-purple-light">
        <div className="block truncate text-base font-medium text-[#797979]">
          {post.source === "CERT/CC" &&
            isCertCCContentType(post.content) &&
            Array.isArray(post.content?.overview?.translated) &&
            post.content.overview.translated.map((item) => (
              <span key={item.id}>
                {item.text || "내용을 불러오는 데 실패했습니다."}
              </span>
            ))}

          {post.source === "CNNVD" &&
            isCnnvdContentType(post.content) &&
            (Array.isArray(post.content?.description?.translated) ? (
              post.content.description.translated.map((item, index) => (
                <span key={index}>
                  {item || "내용을 불러오는 데 실패했습니다."}
                </span>
              ))
            ) : (
              <span>
                {post.content?.description?.translated ||
                  "내용을 불러오는 데 실패했습니다."}
              </span>
            ))}
        </div>
      </CardContent>
      <CardFooter>
        <div className="flex gap-3">
          <VulDBPin pinnedInfo={pinnedInfo} />
          <IconExternalLink />
        </div>
        <CardSubTitle color="#A2A2A2" className="font-medium">
          {daysAgo || "날짜를 알 수 없음"}
        </CardSubTitle>
      </CardFooter>
    </Card>
  );
}

export default function VulDBList({
  posts,
  userId,
}: {
  posts: VulDBPostWithChip[];
  userId?: string;
}) {
  if (!posts || posts.length === 0) {
    return <p className="text-gray-500">데이터가 없습니다.</p>; // 임시
  }

  return (
    <ul className="flex flex-col gap-4">
      {posts.map((post: VulDBPostWithChip) => {
        return (
          <li
            key={post.id}
            onClick={async () => {
              await increasePostViews(post.id);
            }}
          >
            <Link href={`/vuldb/items/${post.id}`}>
              <VulDBListCard post={post} userId={userId as string} />
            </Link>
          </li>
        );
      })}
    </ul>
  );
}
